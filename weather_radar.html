<!DOCTYPE html>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>RainViewer Radar (Compact, Bottom HUD)</title>
<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
/>
<style>
  html,
  body,
  #map {
    height: 100%;
    margin: 0;
  }
  .leaflet-control-attribution {
    font-size: 10px;
  }
  /* ==== æ¥µå°ãƒ»ä¸‹éƒ¨é‡ç•³ ==== */
  .hud {
    position: fixed;
    left: 50%;
    bottom: 8px;
    transform: translateX(-50%);
    z-index: 1000;
    display: flex;
    align-items: center;
    gap: 6px;
    background: #000b;
    color: #fff;
    border-radius: 10px;
    padding: 4px 6px;
    font: 11px/1.2 -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
      "Hiragino Sans", "Noto Sans JP", sans-serif;
    backdrop-filter: blur(3px);
  }
  .hud button {
    cursor: pointer;
    border: 0;
    border-radius: 8px;
    padding: 2px 6px;
    background: #fff1;
    color: #fff;
    font-size: 11px;
  }
  .hud button:hover {
    background: #fff2;
  }
  .hud input[type="range"] {
    width: 160px;
    height: 12px;
  }
  .sep {
    opacity: 0.5;
  }
</style>

<div id="map"></div>

<!-- ä¸‹éƒ¨ãƒ»æ¥µå°HUDï¼ˆã‚¢ã‚¤ã‚³ãƒ³ï¼‹æ™‚åˆ»ã®ã¿ï¼‰ -->
<div class="hud" aria-label="Radar controls">
  <button id="play" title="å†ç”Ÿ/ä¸€æ™‚åœæ­¢">â–¶</button>
  <span class="sep">|</span>
  <input
    id="slider"
    type="range"
    min="0"
    max="0"
    step="1"
    value="0"
    aria-label="ãƒ•ãƒ¬ãƒ¼ãƒ "
  />
  <span class="sep">|</span>
  <button id="locate" title="ç¾åœ¨åœ°ã¸">ğŸ“</button>
  <span id="time" style="opacity: 0.85"></span>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
  const map = L.map("map");
  L.tileLayer("https://tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom: 18,
    attribution: "Â© OpenStreetMap contributors",
  }).addTo(map);

  let userMarker = null;
  function setUserMarker(ll) {
    if (userMarker) map.removeLayer(userMarker);
    userMarker = L.marker(ll).addTo(map);
  }

  const slider = document.getElementById("slider");
  const timeLabel = document.getElementById("time");
  const playBtn = document.getElementById("play");

  let frames = [],
    currentLayer = null,
    idx = 0,
    playing = false,
    timer = null;

  // RainViewer: éå»+äºˆå ±ãƒ•ãƒ¬ãƒ¼ãƒ ã‚’å–å¾—
  fetch("https://api.rainviewer.com/public/weather-maps.json")
    .then((r) => r.json())
    .then((data) => {
      frames = (data.radar?.past || []).concat(data.radar?.nowcast || []);
      if (!frames.length) {
        console.warn("No frames");
        return;
      }
      slider.max = frames.length - 1;
      slider.value = String(frames.length - 1);
      showFrame(+slider.value);
    })
    .catch((e) => console.error("RainViewer fetch error", e));

  function tileUrl(f) {
    // 256pxã‚¿ã‚¤ãƒ« / color=1 / smooth=1
    return `https://tilecache.rainviewer.com/v2/radar/${f.path}/256/{z}/{x}/{y}/2/1_1.png`;
  }
  function showFrame(i) {
    if (!frames.length) return;
    if (currentLayer) map.removeLayer(currentLayer);
    const f = frames[i];
    currentLayer = L.tileLayer(tileUrl(f), { opacity: 0.75 });
    currentLayer.addTo(map);
    idx = i;
    slider.value = String(i);
    const t = new Date(f.time * 1000).toLocaleString("ja-JP", {
      timeZone: "Asia/Tokyo",
    });
    timeLabel.textContent = t;
  }
  function stepNext() {
    showFrame((idx + 1) % frames.length);
  }
  function updatePlayBtn() {
    playBtn.textContent = playing ? "â¸" : "â–¶";
  }

  playBtn.onclick = () => {
    if (!frames.length) return;
    playing = !playing;
    if (playing) {
      timer = setInterval(stepNext, 1100);
    } else {
      clearInterval(timer);
    }
    updatePlayBtn();
  };
  slider.oninput = () => {
    if (playing) {
      playing = false;
      clearInterval(timer);
      updatePlayBtn();
    }
    showFrame(+slider.value);
  };

  function goCurrent() {
    if (!navigator.geolocation) {
      fallback();
      return;
    }
    navigator.geolocation.getCurrentPosition(
      (pos) => {
        const ll = [pos.coords.latitude, pos.coords.longitude];
        setUserMarker(ll);
        map.setView(ll, 10);
      },
      () => fallback(),
      { enableHighAccuracy: true, timeout: 8000, maximumAge: 300000 }
    );
  }
  function fallback() {
    map.setView([35.0, 138.0], 7.0);
  } // é–¢è¥¿ï½é–¢æ±ãŒåã¾ã‚‹ç›®å®‰

  document.getElementById("locate").onclick = goCurrent;
  goCurrent(); // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ç¾åœ¨åœ°è©¦è¡Œ
</script>
