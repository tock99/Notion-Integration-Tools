<!DOCTYPE html>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Google Fit: Weight Chart</title>
<style>
  html, body { height: 100%; margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, "Hiragino Sans", "Noto Sans JP", sans-serif; }
  .wrap { max-width: 900px; margin: 20px auto; padding: 0 12px; }
  .head { display: flex; align-items: center; justify-content: space-between; gap: 12px; }
  .head h2 { margin: 12px 0; font-weight: 600; }
  .head button { font-size: 14px; padding: 6px 10px; cursor: pointer; }
  #msg { font-size: 12px; opacity: .7; margin: 6px 0 10px; }
  /* 固定高さ（約2/3）。横は親幅に合わせるが、描画解像度はJSで固定 */
  canvas { width: 100%; height: 280px; display:block; }
</style>

<div class="wrap">
  <div class="head">
    <h2 id="title">Google Fit – Weight</h2>
    <button id="signIn">Sign in &amp; Fetch</button>
  </div>
  <div id="msg"></div>
  <canvas id="chart"></canvas>
</div>

<!-- （クライアントモード用）Google Identity Services -->
<script src="https://accounts.google.com/gsi/client" async defer></script>
<!-- Chart.js + annotation（線だけ使う） -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1"></script>

<script>
  /* ===== ここだけ変えればOK（バージョン表記） ===== */
  const APP_VERSION = "0.02";

  /* ===== クエリ取得 ===== */
  const qs = new URLSearchParams(location.search);
  const endpoint = qs.get("endpoint");            // Apps Script 等のJSONエンドポイント（Notion推奨）
  const clientId = qs.get("client_id") || "";     // クライアントOAuth用（単体タブ推奨）
  const days = Math.max(7, Math.min(3650, Number(qs.get("days") || 90)));
  const tz = qs.get("tz") || "Asia/Tokyo";
  const goalParam = qs.get("goal");
  const goalKg = goalParam !== null && goalParam !== "" ? Number(goalParam) : null;

  /* ===== DOM ===== */
  const titleEl = document.getElementById("title");
  const msg = document.getElementById("msg");
  const signInBtn = document.getElementById("signIn");
  const canvas = document.getElementById("chart");
  const ctx2d = canvas.getContext("2d");
  const log = (t)=> (msg.textContent = t);

  // タイトルにバージョン
  titleEl.textContent = `Google Fit – Weight (ver: ${APP_VERSION})`;

  // Chart.js 全体デフォルトを抑制（レスポンシブ無効 / DPR固定）
  Chart.defaults.responsive = false;
  Chart.defaults.devicePixelRatio = 1;
  Chart.register(window['chartjs-plugin-annotation']);

  /* ===== キャンバスの物理解像度を一度だけ固定 ===== */
  function fixCanvasPixelSize() {
    // 親のCSSレイアウト幅を取得して、その時点の幅で固定
    const cssWidth = Math.max(320, Math.floor(canvas.getBoundingClientRect().width));
    canvas.width = cssWidth;   // 物理解像度（px）
    canvas.height = 280;       // 物理解像度（px）CSS高さと一致
  }

  /* ===== Y軸レンジ（仕様） ===== */
  function yRangeFrom(valuesKg, goalKg){
    const nums = valuesKg.filter(v => Number.isFinite(v));
    if (!nums.length){
      if (Number.isFinite(goalKg)) return { min: goalKg - 1, max: goalKg + 1 };
      return {}; // データゼロなら自動に任せる
    }
    const minVal = Math.min(...nums), maxVal = Math.max(...nums);
    const min = Number.isFinite(goalKg) ? (goalKg - 1) : (minVal - 1);
    const max = maxVal + 1;
    return { min, max };
  }

  /* ===== 描画 ===== */
  let chart = null;
  function renderChart(labels, labelsFull, valuesKg){
    const range = yRangeFrom(valuesKg, goalKg);

    if (chart) { chart.destroy(); chart = null; }
    chart = new Chart(ctx2d, {
      type: "line",
      data: {
        labels,
        datasets: [{
          data: valuesKg,
          spanGaps: true,    // 欠測でも線で結ぶ
          pointRadius: 2,
          borderWidth: 2,
          tension: 0.2
        }]
      },
      options: {
        // レイアウトを安定化：リサイズ監視・イベント・アニメーションを切る
        responsive: false,
        animation: false,
        events: [],                 // ← マウス/タッチイベントを完全無効化
        maintainAspectRatio: false, // 高さは固定（CSS/属性）
        plugins: {
          legend: { display: false },
          tooltip: { enabled: false },
          annotation: Number.isFinite(goalKg) ? {
            annotations: {
              goalLine: {
                type: 'line',
                yMin: goalKg, yMax: goalKg,
                borderColor: 'red', borderWidth: 2, borderDash: [6,4]
                // ラベルは外して最小限に（再フロー要因を減らす）
              }
            }
          } : {}
        },
        scales: {
          x: { ticks: { maxRotation: 0, autoSkip: true } },
          y: { beginAtZero: false, min: range.min, max: range.max }
        }
      }
    });
  }

  /* ===== データ取得（サーバーモード） ===== */
  async function fetchFromEndpoint(){
    const url = `${endpoint}${endpoint.includes('?') ? '&' : '?'}days=${encodeURIComponent(days)}`;
    const r = await fetch(url, { cache: "no-store" });
    if (!r.ok) throw new Error(`Endpoint error ${r.status}`);
    const j = await r.json(); // { points: [{t,kg}, ...] }

    const fmtMMDD = (ms)=>{
      const d = new Date(ms), o = { month:"2-digit", day:"2-digit" };
      return (tz && tz !== "system") ? d.toLocaleDateString("ja-JP", { timeZone: tz, ...o })
                                     : d.toLocaleDateString("ja-JP", o);
    };
    const fmtYYYYMMDD = (ms)=>{
      const d = new Date(ms), o = { year:"numeric", month:"2-digit", day:"2-digit" };
      return (tz && tz !== "system") ? d.toLocaleDateString("ja-JP", { timeZone: tz, ...o })
                                     : d.toLocaleDateString("ja-JP", o);
    };

    const labels = j.points.map(p => fmtMMDD(p.t));        // X軸は MM/DD 表示
    const labelsFull = j.points.map(p => fmtYYYYMMDD(p.t)); // 予備（今は未使用）
    const valuesKg = j.points.map(p => p.kg);
    return { labels, labelsFull, valuesKg };
  }

  /* ===== クライアントモード（参考：Notionでは推奨しない） ===== */
  const SCOPES = "https://www.googleapis.com/auth/fitness.body.read";
  let accessToken = null, tokenClient = null;

  function readyGIS(){
    return new Promise(r=>{
      const i = setInterval(()=>{ if (window.google?.accounts?.oauth2){ clearInterval(i); r(); }}, 50);
    });
  }
  async function ensureToken(){
    if (accessToken) return accessToken;
    if (!clientId) throw new Error("Missing ?client_id=");
    await readyGIS();
    return new Promise((resolve, reject)=>{
      tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: clientId, scope: SCOPES, prompt: "",
        callback: (resp)=> resp.error ? reject(resp) : (accessToken = resp.access_token, resolve(accessToken))
      });
      tokenClient.requestAccessToken();
    });
  }
  async function fetchFromFit(){
    const now = Date.now(), start = now - days*86400000;
    const body = {
      aggregateBy: [{ dataTypeName: "com.google.weight" }],
      bucketByTime: { durationMillis: 86400000 },
      startTimeMillis: start, endTimeMillis: now
    };
    const res = await fetch("https://www.googleapis.com/fitness/v1/users/me/dataset:aggregate", {
      method: "POST",
      headers: { "Authorization": `Bearer ${accessToken}`, "Content-Type": "application/json" },
      body: JSON.stringify(body)
    });
    if (!res.ok) throw new Error(`Fitness API error ${res.status}`);
    const json = await res.json();

    const pts = (json.bucket||[]).map(b=>{
      const endMs = Number(b.endTimeMillis);
      const ds = b.dataset?.[0]; let kg = null;
      if (ds?.point?.length){ const p = ds.point[ds.point.length-1]; kg = p.value?.[0]?.fpVal ?? null; }
      return { t: endMs, kg };
    });

    const fmtMMDD = (ms)=> {
      const d = new Date(ms), o={month:"2-digit",day:"2-digit"};
      return (tz && tz!=="system") ? d.toLocaleDateString("ja-JP",{timeZone:tz,...o}) : d.toLocaleDateString("ja-JP",o);
    };
    const fmtYYYYMMDD = (ms)=>{
      const d = new Date(ms), o={year:"numeric",month:"2-digit",day:"2-digit"};
      return (tz && tz!=="system") ? d.toLocaleDateString("ja-JP",{timeZone:tz,...o}) : d.toLocaleDateString("ja-JP",o);
    };

    return {
      labels: pts.map(p=>fmtMMDD(p.t)),
      labelsFull: pts.map(p=>fmtYYYYMMDD(p.t)),
      valuesKg: pts.map(p=>p.kg)
    };
  }

  /* ===== 実行 ===== */
  async function run(){
    try{
      // 1) 先にキャンバスの物理解像度を確定 → 2) 描画
      fixCanvasPixelSize();

      log("Loading…");
      if (endpoint){
        signInBtn.style.display = "none"; // サーバーモードはボタン不要
        const { labels, labelsFull, valuesKg } = await fetchFromEndpoint();
        renderChart(labels, labelsFull, valuesKg);
        log(`Done • ${labels.length} days${Number.isFinite(goalKg)?` • goal=${goalKg} kg`:""}`);
        return;
      }
      await ensureToken(); // クライアントモード
      const { labels, labelsFull, valuesKg } = await fetchFromFit();
      renderChart(labels, labelsFull, valuesKg);
      log(`Done • ${labels.length} days${Number.isFinite(goalKg)?` • goal=${goalKg} kg`:""}`);
    }catch(e){
      console.error(e);
      log(e.message || String(e));
    }
  }

  // アクセス時に自動実行（リサイズ監視は一切しない）
  window.addEventListener("load", run);
  // 任意で手動実行も残す
  signInBtn.onclick = run;
</script>
