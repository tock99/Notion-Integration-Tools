<!DOCTYPE html>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Google Fit: Weight Chart</title>
<style>
  html, body { height: 100%; margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, "Hiragino Sans", "Noto Sans JP", sans-serif; }
  .wrap { max-width: 900px; margin: 24px auto; padding: 0 12px; }
  .bar { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; margin-bottom: 12px; }
  .bar input, .bar button, .bar select { font-size: 14px; padding: 6px 8px; }
  #msg { font-size: 12px; opacity: .8; }
  canvas { width: 100%; height: 420px; }
</style>

<div class="wrap">
  <h2>Google Fit – Weight</h2>
  <div class="bar">
    <button id="signIn">Sign in & Fetch</button>
    <label>Days:
      <input id="days" type="number" min="7" max="3650" value="90" />
    </label>
    <label>Unit:
      <select id="unit">
        <option value="kg" selected>kg</option>
        <option value="lb">lb</option>
      </select>
    </label>
    <label>TZ:
      <input id="tz" placeholder="Asia/Tokyo (or 'system')" />
    </label>
    <button id="refresh">Refresh</button>
    <span id="msg"></span>
  </div>
  <canvas id="chart"></canvas>
</div>

<!-- Google Identity Services (OAuth 2.0 for user tokens) -->
<script src="https://accounts.google.com/gsi/client" async defer></script>
<!-- Chart.js for plotting -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<script>
  // ===== Helpers =====
  const qs = new URLSearchParams(location.search);
  const clientId = qs.get("client_id") || ""; // REQUIRED
  const daysParam = Math.max(7, Math.min(3650, Number(qs.get("days") || 90)));
  const unitParam = (qs.get("unit") || "kg").toLowerCase() === "lb" ? "lb" : "kg";
  const tzParam = qs.get("tz") || "Asia/Tokyo";

  const daysInput = document.getElementById("days");
  const unitSelect = document.getElementById("unit");
  const tzInput = document.getElementById("tz");
  const msg = document.getElementById("msg");
  daysInput.value = String(daysParam);
  unitSelect.value = unitParam;
  tzInput.value = tzParam;

  const SCOPES = "https://www.googleapis.com/auth/fitness.body.read";
  let tokenClient = null;
  let accessToken = null;

  function log(m) { msg.textContent = m; }
  function toLb(kg) { return kg * 2.2046226218; }

  // Use Aggregate API: https://developers.google.com/fit/rest/v1/users/dataset/aggregate
  // We bucket by 1 day and request com.google.weight
  async function fetchWeightSeries(days, tz) {
    const now = Date.now();
    const start = now - days * 24 * 60 * 60 * 1000;

    const body = {
      aggregateBy: [{ dataTypeName: "com.google.weight" }],
      bucketByTime: { durationMillis: 24 * 60 * 60 * 1000 },
      startTimeMillis: start,
      endTimeMillis: now
    };

    const res = await fetch("https://www.googleapis.com/fitness/v1/users/me/dataset:aggregate", {
      method: "POST",
      headers: {
        "Authorization": `Bearer ${accessToken}`,
        "Content-Type": "application/json"
      },
      body: JSON.stringify(body)
    });

    if (!res.ok) {
      const t = await res.text();
      throw new Error(`Fitness API error ${res.status}: ${t}`);
    }
    const json = await res.json();

    // Parse buckets -> pick the latest value in each day if exists
    const points = [];
    for (const b of (json.bucket || [])) {
      const endMs = Number(b.endTimeMillis);
      const ds = (b.dataset && b.dataset[0]) ? b.dataset[0] : null;
      let kg = null;
      if (ds && Array.isArray(ds.point) && ds.point.length) {
        // choose last point's value
        const p = ds.point[ds.point.length - 1];
        if (p.value && p.value[0]) {
          // weight is a "fpVal" (kg)
          kg = p.value[0].fpVal;
        }
      }
      // push even if null to preserve gaps (Chart.js can show gaps)
      points.push({ t: endMs, kg });
    }

    // format labels with timezone
    const fmt = (ms) => {
      const d = new Date(ms);
      if (tz && tz !== "system") {
        return d.toLocaleString("ja-JP", { timeZone: tz, year: "numeric", month: "2-digit", day: "2-digit" });
      }
      return d.toLocaleDateString();
    };

    const labels = points.map(p => fmt(p.t));
    const valuesKg = points.map(p => p.kg);
    return { labels, valuesKg };
  }

  // ===== Chart.js =====
  const ctx = document.getElementById("chart");
  let chart = null;
  function renderChart(labels, valuesKg, unit) {
    const data = unit === "lb" ? valuesKg.map(v => v == null ? null : toLb(v)) : valuesKg;
    const uLabel = unit === "lb" ? "Weight (lb)" : "Weight (kg)";

    if (chart) chart.destroy();
    chart = new Chart(ctx, {
      type: "line",
      data: {
        labels,
        datasets: [{
          label: uLabel,
          data,
          spanGaps: false,
          pointRadius: 2,
          borderWidth: 2,
          tension: 0.2
        }]
      },
      options: {
        responsive: true,
        animation: false,
        plugins: {
          legend: { display: true }
        },
        scales: {
          x: { ticks: { maxRotation: 0, autoSkip: true } },
          y: { beginAtZero: false }
        }
      }
    });
  }

  // ===== OAuth (GIS) =====
  async function ensureToken() {
    if (accessToken) return accessToken;
    if (!clientId) {
      throw new Error("Missing client_id. Append ?client_id=YOUR_CLIENT_ID to the URL.");
    }
    // Wait for GIS to be ready
    await new Promise(r => {
      const i = setInterval(() => {
        if (window.google && window.google.accounts && window.google.accounts.oauth2) {
          clearInterval(i); r();
        }
      }, 50);
    });

    return new Promise((resolve, reject) => {
      tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: clientId,
        scope: SCOPES,
        prompt: "", // empty = silent if possible, otherwise consent
        callback: (resp) => {
          if (resp.error) { reject(resp); return; }
          accessToken = resp.access_token;
          resolve(accessToken);
        }
      });
      tokenClient.requestAccessToken(); // may open a consent popup
    });
  }

  async function run() {
    try {
      log("Authorizing…");
      await ensureToken();
      log("Fetching weight…");
      const days = Number(daysInput.value) || 90;
      const unit = unitSelect.value;
      const tz = tzInput.value || "Asia/Tokyo";
      const { labels, valuesKg } = await fetchWeightSeries(days, tz);
      renderChart(labels, valuesKg, unit);
      log(`Done • ${labels.length} days`);
    } catch (e) {
      console.error(e);
      log(e.message || String(e));
    }
  }

  document.getElementById("signIn").onclick = run;
  document.getElementById("refresh").onclick = run;

  // Auto-run if token can be obtained silently (returning visitors)
  window.addEventListener("load", async () => {
    try {
      if (clientId) {
        await ensureToken(); // may be silent
        await run();
      } else {
        log("Set ?client_id=… to start.");
      }
    } catch (e) {
      // ignore; user can click "Sign in & Fetch"
      console.warn("Silent auth failed:", e);
      log("Click “Sign in & Fetch”.");
    }
  });
</script>
