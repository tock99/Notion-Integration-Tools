<!DOCTYPE html>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Google Fit: Weight Chart</title>
<style>
  html, body { height: 100%; margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, "Hiragino Sans", "Noto Sans JP", sans-serif; }
  .wrap { max-width: 900px; margin: 20px auto; padding: 0 12px; }
  .head { display: flex; align-items: center; justify-content: space-between; gap: 12px; }
  .head h2 { margin: 12px 0; font-weight: 600; }
  /* 小さめボタン */
  .head button { font-size: 12px; padding: 4px 8px; cursor: pointer; border-radius: 6px; }
  /* 固定高さで安定表示（Notion向け） */
  canvas { width: 100%; height: 280px; display:block; }
</style>

<div class="wrap">
  <div class="head">
    <h2 id="title">Google Fit – Weight</h2>
    <button id="signIn">Sign in &amp; Fetch</button>
  </div>
  <canvas id="chart"></canvas>
</div>

<!-- Frontend OAuth（frontendモード時のみ使用） -->
<script src="https://accounts.google.com/gsi/client" async defer></script>
<!-- Chart.js + 時間軸アダプタ + annotation -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1"></script>

<script>
  /* ===== 表示バージョン（?ver= で上書き可） ===== */
  const DEFAULT_APP_VERSION = "0.03";

  /* ===== クエリ ===== */
  const qs = new URLSearchParams(location.search);
  const modeParam = (qs.get("mode") || "auto").toLowerCase(); // server | frontend | auto
  const endpointRaw = qs.get("endpoint") || "";
  const clientId = qs.get("client_id") || "";
  const days = Math.max(7, Math.min(3650, Number(qs.get("days") || 90)));
  const tz = qs.get("tz") || "Asia/Tokyo";
  const goalKg = qs.has("goal") ? Number(qs.get("goal")) : null;
  const yminQ = qs.has("ymin") ? Number(qs.get("ymin")) : null;
  const ymaxQ = qs.has("ymax") ? Number(qs.get("ymax")) : null;
  const APP_VERSION = qs.get("ver") || DEFAULT_APP_VERSION;

  // 実行モード
  let activeMode = "frontend";
  if (modeParam === "server") activeMode = "server";
  else if (modeParam === "frontend") activeMode = "frontend";
  else activeMode = endpointRaw ? "server" : "frontend"; // auto

  /* ===== DOM ===== */
  const titleEl = document.getElementById("title");
  const signInBtn = document.getElementById("signIn");
  const canvas = document.getElementById("chart");
  const ctx2d = canvas.getContext("2d");

  titleEl.textContent = `Google Fit – Weight (ver: ${APP_VERSION})`;

  /* ===== Chart.js 安定化 ===== */
  Chart.defaults.responsive = false;
  Chart.defaults.devicePixelRatio = 1;
  Chart.register(window['chartjs-plugin-annotation']);

  // 物理解像度固定（Notionのリサイズ干渉を回避）
  function fixCanvasPixelSize() {
    const cssWidth = Math.max(320, Math.floor(canvas.getBoundingClientRect().width));
    canvas.width = cssWidth;
    canvas.height = 280;
  }

  /* ===== Y軸レンジ計算 =====
     既定: min = (goalあり) ? goal-1 : データ最小-1
           max = データ最大+1
     クエリ yMin / yMax があれば優先
  */
  function yRangeFrom(valuesKg, goalKg){
    const nums = valuesKg.filter(v => Number.isFinite(v));
    let minAuto, maxAuto;
    if (nums.length) {
      const minVal = Math.min(...nums), maxVal = Math.max(...nums);
      minAuto = Number.isFinite(goalKg) ? (goalKg - 1) : (minVal - 1);
      maxAuto = maxVal + 1;
    } else {
      // データゼロ時の最低限
      if (Number.isFinite(goalKg)) { minAuto = goalKg - 1; maxAuto = goalKg + 1; }
      else { minAuto = undefined; maxAuto = undefined; }
    }
    let min = Number.isFinite(yminQ) ? yminQ : minAuto;
    let max = Number.isFinite(ymaxQ) ? ymaxQ : maxAuto;
    // min/max の整合性確保
    if (Number.isFinite(min) && Number.isFinite(max) && min >= max) {
      max = min + 1;
    }
    return { min, max };
  }

  /* ===== 描画 ===== */
  let chart = null;
  function renderChart(points){ // points: [{t(ms), kg}]
    const dates = points.map(p => new Date(p.t));
    const valuesKg = points.map(p => p.kg);

    const range = yRangeFrom(valuesKg, goalKg);

    if (chart) { chart.destroy(); chart = null; }
    chart = new Chart(ctx2d, {
      type: "line",
      data: {
        labels: dates,         // Date objects
        datasets: [{
          data: valuesKg,
          spanGaps: true,      // 欠測でも線で結ぶ
          pointRadius: 2,
          borderWidth: 2,
          tension: 0.2
        }]
      },
      options: {
        responsive: false,
        animation: false,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          tooltip: {
            enabled: true,
            callbacks: {
              label(ctx){
                const ms = ctx.parsed.x;
                const v = ctx.parsed.y;
                const d = new Date(ms);
                const dateStr = (tz && tz !== "system")
                  ? d.toLocaleDateString("ja-JP", { timeZone: tz, year:"numeric", month:"2-digit", day:"2-digit" })
                  : d.toLocaleDateString("ja-JP", { year:"numeric", month:"2-digit", day:"2-digit" });
                return `${dateStr} ${Number.isFinite(v) ? v.toFixed(2) + "kg" : "-"}`;
              },
              title(){ return ""; }
            }
          },
          annotation: Number.isFinite(goalKg) ? {
            annotations: {
              goalLine: {
                type: 'line',
                yMin: goalKg, yMax: goalKg,
                borderColor: 'red',
                borderWidth: 2,
                borderDash: [6, 4]
              }
            }
          } : {}
        },
        scales: {
          x: {
            type: "time",
            time: { unit: "day" }, // データは日次
            ticks: {
              // 本日基準で週ごとに表示（MM/DD）
              callback: (val, idx, ticks) => {
                const v = this && this.getLabelForValue ? this.getLabelForValue(val) : null;
                // Chart.js v4 の time スケールでは ctx が無いので、ticks[idx].value を使う
                const ms = ticks[idx] && ticks[idx].value ? ticks[idx].value : null;
                if (ms == null) return "";
                const now = new Date();
                const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                const d = new Date(ms);
                const day = new Date(d.getFullYear(), d.getMonth(), d.getDate());
                const diff = Math.round((today - day) / 86400000); // 日差
                if (diff % 7 === 0) {
                  const s = (tz && tz !== "system")
                    ? day.toLocaleDateString("ja-JP", { timeZone: tz, month:"2-digit", day:"2-digit" })
                    : day.toLocaleDateString("ja-JP", { month:"2-digit", day:"2-digit" });
                  return s; // MM/DD
                }
                return "";
              },
              maxRotation: 0,
              autoSkip: false
            }
          },
          y: { beginAtZero: false, min: range.min, max: range.max }
        }
      }
    });
  }

  /* ===== データ取得 ===== */
  // endpoint はエンコード/非エンコードの両対応
  function buildEndpointUrl(raw){
    try { return new URL(raw); }
    catch(_){ try { return new URL(decodeURIComponent(raw)); } catch(e){ throw e; } }
  }

  async function fetchFromEndpoint(){
    const u = buildEndpointUrl(endpointRaw);
    u.searchParams.set("days", String(days));
    const r = await fetch(u.toString(), { cache: "no-store" });
    if (!r.ok) throw new Error(`Endpoint error ${r.status}`);
    const j = await r.json(); // { points: [{t,kg}, ...] }
    return j.points || [];
  }

  const SCOPES = "https://www.googleapis.com/auth/fitness.body.read";
  let accessToken = null, tokenClient = null;

  function readyGIS(){
    return new Promise(r=>{
      const i = setInterval(()=>{ if (window.google?.accounts?.oauth2){ clearInterval(i); r(); }}, 50);
    });
  }
  async function ensureToken(){
    if (accessToken) return accessToken;
    if (!clientId) throw new Error("Missing ?client_id=");
    await readyGIS();
    return new Promise((resolve, reject)=>{
      tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: clientId, scope: SCOPES, prompt: "",
        callback: (resp)=> resp.error ? reject(resp) : (accessToken = resp.access_token, resolve(accessToken))
      });
      tokenClient.requestAccessToken();
    });
  }

  async function fetchFromFit(){
    const now = Date.now(), start = now - days*86400000;
    const body = {
      aggregateBy: [{ dataSourceId: "derived:com.google.weight:com.google.android.gms:merge_weight" }],
      bucketByTime: { durationMillis: 86400000 },
      startTimeMillis: start, endTimeMillis: now
    };
    const res = await fetch("https://www.googleapis.com/fitness/v1/users/me/dataset:aggregate", {
      method: "POST",
      headers: { "Authorization": `Bearer ${accessToken}`, "Content-Type": "application/json" },
      body: JSON.stringify(body)
    });
    if (!res.ok) throw new Error(`Fitness API error ${res.status}`);
    const json = await res.json();
    const pts = (json.bucket||[]).map(b=>{
      const endMs = Number(b.endTimeMillis);
      const ds = b.dataset?.[0]; let kg = null;
      if (ds?.point?.length){ const p = ds.point[ds.point.length-1]; kg = p.value?.[0]?.fpVal ?? null; }
      return { t: endMs, kg };
    });
    return pts;
  }

  /* ===== 実行 ===== */
  async function run(){
    try{
      fixCanvasPixelSize();

      if (activeMode === "server") {
        signInBtn.style.display = "none";
        const points = await fetchFromEndpoint();
        renderChart(points);
      } else {
        signInBtn.style.display = ""; // 小さめボタン（CSS）
        await ensureToken();
        const points = await fetchFromFit();
        renderChart(points);
      }
    }catch(e){
      console.error(e);
      // 画面へのステータス表示は撤去（ご要望どおり）
      alert(e.message || String(e)); // 必要なら削除可
    }
  }

  window.addEventListener("load", run);
  signInBtn.onclick = run;
</script>
