<!DOCTYPE html>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>今日の一枚</title>
<style>
  :root { color-scheme: light dark; }
  * { box-sizing: border-box; }
  html, body { margin: 0; padding: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, "Hiragino Sans", "Noto Sans JP", sans-serif; }
  /* 余白ゼロ（必要なら pad / margin クエリで上書き） */
  .wrap { margin: 0; padding: 0; width: 100%; max-width: none; }
  .head { display: flex; align-items: center; justify-content: space-between; gap: 8px; }
  .head h2 { margin: 0; font-size: 14px; font-weight: 600; opacity: .85; }
  .head small { opacity: .6; }

  .frame { position: relative; width: 100%; max-width: 100%; overflow: hidden; }
  .ph {
    width: 100%; height: 300px; /* JSで上書き */
    display: block;
    background: linear-gradient(120deg, #eee 25%, #f7f7f7 37%, #eee 63%);
    background-size: 400% 100%;
    animation: shimmer 1.3s infinite;
    border-radius: 12px; box-shadow: 0 6px 18px rgba(0,0,0,.12);
    object-fit: cover; object-position: center;
  }
  @keyframes shimmer { 0%{background-position: 100% 0} 100%{background-position: 0 0} }

  /* 画像左下：キャプション（白文字） */
  .cap {
    position: absolute; bottom: 6px; left: 8px;
    font-size: 12px; color: #fff; max-width: 88%;
    text-shadow: 0 0 4px rgba(0,0,0,.6);
    white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    user-select: none; pointer-events: none;
  }
  /* 画像右下：バージョン（白文字・極小） */
  .ver {
    position: absolute; bottom: 6px; right: 8px;
    font-size: 10px; color: #fff;
    text-shadow: 0 0 4px rgba(0,0,0,.6);
    user-select: none; pointer-events: none;
  }
  /* デバッグ用オーバーレイ */
  .dbg {
    position: fixed; top: 6px; left: 8px; z-index: 1000;
    font: 11px ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
    background: #000a; color: #fff; padding: 4px 6px; border-radius: 6px;
    display: none; white-space: pre-wrap; max-width: 90vw;
  }

  a.noline { text-decoration: none; color: inherit; display:block; }
</style>

<div class="wrap" id="wrap">
  <div class="head" id="head">
    <h2>今日の一枚</h2>
    <small id="date"></small>
  </div>

  <div class="frame" id="frame">
    <a id="href" class="noline" target="_blank" rel="noopener noreferrer">
      <img id="img" alt="今日の一枚" class="ph" referrerpolicy="no-referrer">
      <div class="cap" id="cap"></div>
      <div class="ver" id="ver"></div>
    </a>
  </div>
</div>
<div class="dbg" id="dbg"></div>

<script>
/* ========= バージョン ========= */
const DEFAULT_APP_VERSION = "0.04";

/* ========= クエリ =========
   source: auto|bing|unsplash|wikimedia|nasa|picsum（既定 auto）
   q: テーマ語（Unsplash/Picsum seed）
   proxy: 1/0 Unsplash直リンクが失敗時にプロキシ再試行（既定1=使う）
   nasa_key: NASA APODのAPIキー（既定 DEMO_KEY）
   w,h,fit,radius,shadow,border,caption,mkt,tz,ver,header,link,scroll,pad,margin は前回と同様
   debug: 1で左上に進行状況表示
*/
const qs = new URLSearchParams(location.search);
const SOURCE = (qs.get("source") || "auto").toLowerCase();
const Q = qs.get("q") || "";
const USE_PROXY = qs.get("proxy") !== "0";
const NASA_KEY = qs.get("nasa_key") || "DEMO_KEY";
const WQ = qs.get("w") || "100%";
const HQ = Math.max(120, Number(qs.get("h") || 300));
const FIT = (qs.get("fit") || "cover");
const RADIUS = Number(qs.get("radius") || 12);
const SHADOW = qs.get("shadow") !== "0";
const BORDER = qs.get("border") || "";
const CAPTION = qs.get("caption") !== "0";
const MKT = qs.get("mkt") || "ja-JP";
const TZ = qs.get("tz") || "Asia/Tokyo";
const APP_VERSION = qs.get("ver") || DEFAULT_APP_VERSION;
const SHOW_HEADER = qs.get("header") !== "0";
const LINK_ENABLED = qs.get("link") !== "0";
const SHOW_SCROLL = qs.get("scroll") === "1";
const PAD = Number(qs.get("pad") ?? 0);
const MARGIN = Number(qs.get("margin") ?? 0);
const DEBUG = qs.get("debug") === "1";

/* ========= DOM ========= */
const wrap = document.getElementById("wrap");
const head = document.getElementById("head");
const frame = document.getElementById("frame");
const img = document.getElementById("img");
const href = document.getElementById("href");
const cap = document.getElementById("cap");
const verEl = document.getElementById("ver");
const dbg = document.getElementById("dbg");

/* スクロール/余白/ヘッダー */
if (!SHOW_SCROLL) { document.documentElement.style.overflow = "hidden"; document.body.style.overflow = "hidden"; }
wrap.style.padding = PAD + "px";
wrap.style.margin = MARGIN + "px";
if (!SHOW_HEADER) { head.style.display = "none"; verEl.style.display = "none"; }
document.getElementById("date").textContent =
  new Date().toLocaleDateString("ja-JP", { timeZone: TZ, year:"numeric", month:"2-digit", day:"2-digit" });
verEl.textContent = "ver " + APP_VERSION;

/* サイズ・スタイル */
if (/^\d+(\.\d+)?$/.test(WQ)) { frame.style.width = WQ + "px"; } else { frame.style.width = WQ; }
img.style.height = HQ + "px";
img.style.objectFit = (FIT === "contain") ? "contain" : "cover";
img.style.borderRadius = RADIUS + "px";
if (BORDER) img.style.border = BORDER;
if (!SHADOW) img.style.boxShadow = "none";
if (!LINK_ENABLED) { href.removeAttribute("href"); href.style.pointerEvents = "none"; }
if (DEBUG) { dbg.style.display = "block"; }

/* ========= 小道具 ========= */
function log(s){ if (DEBUG) dbg.textContent += (dbg.textContent ? "\n" : "") + s; }
function todayParts(tz){
  const d = new Date(new Date().toLocaleString("en-US",{ timeZone: tz }));
  return { y: d.getFullYear(), m: String(d.getMonth()+1).padStart(2,"0"), d: String(d.getDate()).padStart(2,"0") };
}
function todaySeed(tz){ const p = todayParts(tz); return `${p.y}${p.m}${p.d}`; }

/* CORSテキスト取得（フェイルオーバー：AllOrigins → r.jina.ai） */
async function fetchTextCORS(url){
  const naked = url.replace(/^https?:\/\//,'');
  const tries = [
    `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`,
    `https://r.jina.ai/https://${naked}`,
    `https://r.jina.ai/http://${naked}`,
  ];
  for (const u of tries) {
    try {
      log(`fetch: ${u}`);
      const r = await fetch(u, { cache: "no-store" });
      if (r.ok) return r.text();
    } catch(e){ log("fetch error: " + e.message); }
  }
  throw new Error("CORS fetch failed");
}

/* 画像プロキシ（weserv） */
function proxyUrl(u, w, h, fit) {
  const naked = u.replace(/^https?:\/\//, "");
  const ps = [`url=${encodeURIComponent(naked)}`];
  if (/^\d+$/.test(String(w))) ps.push(`w=${w}`);
  if (/^\d+$/.test(String(h))) ps.push(`h=${h}`);
  if (fit === "cover" || fit === "contain") ps.push(`fit=${fit}`);
  ps.push("we=1");
  return `https://images.weserv.nl/?${ps.join("&")}`;
}

/* 画像ロード（失敗時のプロキシ再試行つき） */
async function tryLoadWithProxy(url, wnum){
  try {
    await loadImageWithTimeout(url);
    return url;
  } catch (e) {
    log("direct load failed → proxy try");
    const proxied = proxyUrl(url, wnum, HQ, FIT);
    await loadImageWithTimeout(proxied);
    return proxied;
  }
}
function loadImageWithTimeout(src, timeoutMs = 7000) {
  return new Promise((resolve, reject)=>{
    let done = false;
    const i = new Image();
    const timer = setTimeout(()=>{ if (!done){ done = true; reject(new Error("Image load timeout")); } }, timeoutMs);
    i.onload = ()=>{ if (!done){ done = true; clearTimeout(timer); resolve(); } };
    i.onerror = ()=>{ if (!done){ done = true; clearTimeout(timer); reject(new Error("Image load error")); } };
    i.referrerPolicy = (src.includes("bing.com")) ? "no-referrer" : "";
    i.src = src;
  });
}

/* ========= 各ソース ========= */
async function fetchBing() {
  log("source: Bing");
  const api = `https://www.bing.com/HPImageArchive.aspx?format=js&idx=0&n=1&mkt=${encodeURIComponent(MKT)}`;
  const text = await fetchTextCORS(api);
  const json = JSON.parse(text);
  const it = json.images && json.images[0];
  if (!it) throw new Error("Bing: no image");
  const direct = it.url.startsWith("http") ? it.url : "https://www.bing.com" + it.url;
  const title = it.title || "";
  const copy = it.copyright || "";
  return { url: direct, page: "https://www.bing.com", title, credit: copy || "Bing" };
}
function buildUnsplashUrl(q, w, h, seed) {
  const kw = (q || "landscape").split(",").map(s=>s.trim()).filter(Boolean).join(",");
  const dims = (/^\d+$/.test(String(w)) && /^\d+$/.test(String(h))) ? `/${w}x${h}` : "";
  return `https://source.unsplash.com/featured${dims}/?${encodeURIComponent(kw)}&sig=${encodeURIComponent(seed)}`;
}
async function fetchUnsplash() {
  log("source: Unsplash");
  const wnum = /^\d+$/.test(String(WQ)) ? Number(WQ) : 1200;
  const seed = todaySeed(TZ) + (Q ? "_" + Q : "");
  const direct = buildUnsplashUrl(Q, wnum, HQ, seed);
  const url = USE_PROXY ? proxyUrl(direct, wnum, HQ, FIT) : direct; // まずは指定方針で
  return { url, page: `https://unsplash.com/s/photos/${encodeURIComponent(Q || "landscape")}`, title: Q ? `テーマ: ${Q}` : "Unsplash featured", credit: "Unsplash", _wnum: wnum, _direct: direct };
}
async function fetchWikimedia() {
  log("source: Wikimedia");
  const p = todayParts(TZ);
  const api = `https://en.wikipedia.org/api/rest_v1/feed/featured/${p.y}/${p.m}/${p.d}`;
  const r = await fetch(api, { cache: "no-store" });
  if (!r.ok) throw new Error("Wikimedia fetch failed: " + r.status);
  const data = await r.json();
  const src = data?.image?.image?.source || data?.image?.thumbnail?.source;
  if (!src) throw new Error("Wikimedia: no image source");
  const title = (data?.image?.description?.text || "").replace(/<[^>]*>/g,"").trim() || (data?.image?.title || "Wikimedia Picture of the Day");
  return { url: src, page: "https://commons.wikimedia.org/wiki/Commons:Picture_of_the_day", title, credit: "Wikimedia Commons" };
}
async function fetchNasa() {
  log("source: NASA APOD");
  const p = todayParts(TZ);
  const api = `https://api.nasa.gov/planetary/apod?api_key=${encodeURIComponent(NASA_KEY)}&thumbs=true&date=${p.y}-${p.m}-${p.d}`;
  const text = await fetchTextCORS(api);
  const j = JSON.parse(text);
  const isImg = j.media_type === "image";
  const src = isImg ? (j.hdurl || j.url) : (j.thumbnail_url || j.url);
  if (!src) throw new Error("NASA APOD: no image URL");
  const title = j.title || "NASA Astronomy Picture of the Day";
  const credit = j.copyright ? `NASA / ${j.copyright}` : "NASA APOD";
  return { url: src, page: j.hdurl || j.url || "https://apod.nasa.gov/", title, credit };
}
async function fetchPicsum() {
  log("source: Picsum");
  const wnum = /^\d+$/.test(String(WQ)) ? Number(WQ) : 1200;
  const seed = todaySeed(TZ) + (Q ? "_" + Q : "");
  const url = `https://picsum.photos/seed/${encodeURIComponent(seed)}/${wnum}/${HQ}`;
  return { url, page: "https://picsum.photos/", title: Q ? `Picsum – ${Q}` : "Picsum – Random", credit: "Picsum" };
}

/* ========= 解決（フォールバック & プロキシ再試行） ========= */
async function resolveImage() {
  const order = [];
  if (SOURCE === "auto") {
    order.push(Q ? fetchUnsplash : fetchBing, fetchWikimedia, Q ? fetchBing : fetchUnsplash, fetchPicsum, fetchNasa);
  } else {
    const map = { bing: fetchBing, unsplash: fetchUnsplash, wikimedia: fetchWikimedia, nasa: fetchNasa, picsum: fetchPicsum };
    if (!map[SOURCE]) throw new Error("Unknown source: " + SOURCE);
    order.push(map[SOURCE], fetchBing, fetchUnsplash, fetchPicsum, fetchNasa);
  }

  for (const fn of order) {
    try {
      const r = await fn();
      let finalUrl = r.url;
      const wnum = r._wnum; // Unsplash用
      // まず直接ロード → 失敗したら weserv で再試行
      try {
        await loadImageWithTimeout(finalUrl);
      } catch (e) {
        log("direct failed: " + (new URL(finalUrl).hostname));
        if (USE_PROXY) {
          finalUrl = proxyUrl(r._direct || finalUrl, wnum || (/^\d+$/.test(String(WQ)) ? Number(WQ) : 1200), HQ, FIT);
          await loadImageWithTimeout(finalUrl);
        } else {
          throw e;
        }
      }
      return { ...r, url: finalUrl }; // 成功
    } catch (e) {
      log("source failed: " + e.message);
      continue;
    }
  }
  throw new Error("All sources failed");
}

/* ========= 表示 ========= */
(async () => {
  try {
    const { url, page, title, credit } = await resolveImage();
    img.onload = () => img.classList.remove("ph");
    img.referrerPolicy = (url.includes("bing.com")) ? "no-referrer" : "";
    img.src = url;
    href.href = LINK_ENABLED ? (page || url) : "javascript:void(0)";
    if (CAPTION) { cap.style.display = ""; cap.textContent = title ? `${title} — ${credit}` : credit; }
    else { cap.style.display = "none"; }
  } catch (e) {
    log("fatal: " + e.message);
    cap.style.display = "";
    cap.textContent = "画像を取得できませんでした。";
  }
})();
</script>
